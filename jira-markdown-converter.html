<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QuickDevKit - Jira와 Markdown 간 양방향 변환기. 빠르고 정확한 문법 변환 도구">
    <meta name="keywords" content="jira converter, markdown converter, jira to markdown, markdown to jira, developer tools, quickdevkit">
    <meta name="google-adsense-account" content="ca-pub-2369255699430177">
    <title>QuickDevKit - Jira ↔ Markdown Converter</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            transition: all 0.2s ease;
        }

        body.dark {
            background-color: #111827;
            color: #f9fafb;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .dark .header {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .dark .logo {
            color: #f9fafb;
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: #3b82f6;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            margin-left: 2rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            text-decoration: none;
        }

        .nav-tab.active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .dark .nav-tab.active {
            background: #1e3a8a;
            color: #93c5fd;
        }

        .nav-tab:not(.active) {
            color: #6b7280;
        }

        .nav-tab:not(.active):hover {
            color: #374151;
        }

        .dark .nav-tab:not(.active) {
            color: #9ca3af;
        }

        .dark .nav-tab:not(.active):hover {
            color: #d1d5db;
        }

        .theme-toggle {
            background: #f3f4f6;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .theme-toggle:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .dark .theme-toggle {
            background: #374151;
            color: #9ca3af;
        }

        .dark .theme-toggle:hover {
            background: #4b5563;
            color: #d1d5db;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .converter-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: start;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .converter-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .converter-controls {
                order: -1;
            }
        }

        .editor-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .dark .editor-panel {
            background: #1f2937;
            border: 1px solid #374151;
        }

        .panel-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .dark .panel-header {
            background: #374151;
            border-bottom: 1px solid #4b5563;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .dark .panel-title {
            color: #f9fafb;
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            background: #f3f4f6;
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn:hover {
            background: #e5e7eb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .dark .btn {
            background: #4b5563;
            color: #d1d5db;
        }

        .dark .btn:hover {
            background: #6b7280;
        }

        .editor-wrapper {
            position: relative;
            height: 400px;
            border-radius: 0 0 0.5rem 0.5rem;
            overflow: hidden;
        }

        .CodeMirror {
            height: 400px !important;
            width: 100% !important;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .CodeMirror-scroll {
            max-height: 400px !important;
            overflow-y: auto !important;
            overflow-x: auto !important;
        }

        .converter-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }

        .convert-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
        }

        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.35);
        }

        .convert-btn:active {
            transform: translateY(0);
        }

        .arrow-icon {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
        }

        .convert-btn:hover .arrow-icon {
            transform: translateX(3px);
        }

        .status-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
            transition: all 0.2s ease;
        }

        .dark .status-panel {
            background: #1f2937;
            border: 1px solid #374151;
        }

        .status-success {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .dark .status-success {
            background: #064e3b;
            border-color: #065f46;
        }

        .status-error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .dark .status-error {
            background: #7f1d1d;
            border-color: #991b1b;
        }

        .status-content {
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .status-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.125rem;
        }

        .status-text {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .status-message {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .copied-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .copied-badge.show {
            transform: translateY(0);
            opacity: 1;
        }

        .footer {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 1.5rem;
            text-align: center;
            margin-top: 3rem;
            transition: all 0.2s ease;
        }

        .dark .footer {
            background: #1f2937;
            border-top: 1px solid #374151;
        }

        .footer-text {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .footer-text {
            color: #9ca3af;
        }

        .guide-section {
            margin: 3rem 0;
            padding: 2rem 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .dark .section-title {
            color: #f9fafb;
        }

        .section-subtitle {
            color: #6b7280;
            font-size: 1.125rem;
        }

        .dark .section-subtitle {
            color: #9ca3af;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .guide-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .guide-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .dark .guide-card {
            background: #1f2937;
            border-color: #374151;
        }

        .dark .guide-card:hover {
            border-color: #3b82f6;
        }

        .guide-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .guide-card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .dark .guide-card-header h3 {
            color: #f9fafb;
        }

        .expand-icon {
            color: #6b7280;
            font-size: 0.875rem;
            transition: transform 0.3s ease;
        }

        .guide-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .guide-card-desc {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
        }

        .dark .guide-card-desc {
            color: #9ca3af;
        }

        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 1rem;
        }

        .guide-content.show {
            max-height: 1000px;
        }

        .content-example {
            margin-bottom: 1.5rem;
        }

        .content-example h4 {
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .dark .content-example h4 {
            color: #d1d5db;
        }

        .content-example pre {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .content-example pre {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <div class="logo">
                    <div class="logo-icon">⚡</div>
                    <span>QuickDevKit</span>
                </div>
                
                <nav class="nav-tabs">
                    <a href="index.html" class="nav-tab">JSON Tool</a>
                    <a href="svg-converter.html" class="nav-tab">SVG Converter</a>
                    <button class="nav-tab active">Jira ↔ Markdown</button>
                    <button class="nav-tab" disabled>Base64 (Coming Soon)</button>
                </nav>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="theme-toggle" onclick="toggleTheme()" title="테마 변경">
                    <span id="theme-icon">🌙</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="converter-container">
            <!-- Jira Input Panel -->
            <div class="editor-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Jira 문법</h2>
                    <div class="panel-actions">
                        <button class="btn" onclick="loadJiraSample()">샘플 로드</button>
                        <button class="btn" onclick="clearJiraInput()">지우기</button>
                        <button class="btn btn-primary" onclick="copyJiraInput()">
                            <span>📋</span>
                            <span>복사</span>
                        </button>
                    </div>
                </div>
                <div class="editor-wrapper" style="position: relative;">
                    <div id="jira-editor"></div>
                    <div class="copied-badge" id="jira-copied-badge">복사됨!</div>
                </div>
            </div>

            <!-- Converter Controls -->
            <div class="converter-controls">
                <button class="convert-btn" onclick="convertJiraToMarkdown()">
                    <span>Jira → MD</span>
                    <span class="arrow-icon">→</span>
                </button>
                <button class="convert-btn" onclick="convertMarkdownToJira()">
                    <span class="arrow-icon">←</span>
                    <span>MD → Jira</span>
                </button>
            </div>

            <!-- Markdown Output Panel -->
            <div class="editor-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Markdown 문법</h2>
                    <div class="panel-actions">
                        <button class="btn" onclick="loadMarkdownSample()">샘플 로드</button>
                        <button class="btn" onclick="clearMarkdownInput()">지우기</button>
                        <button class="btn btn-primary" onclick="copyMarkdownInput()">
                            <span>📋</span>
                            <span>복사</span>
                        </button>
                    </div>
                </div>
                <div class="editor-wrapper" style="position: relative;">
                    <div id="markdown-editor"></div>
                    <div class="copied-badge" id="markdown-copied-badge">복사됨!</div>
                </div>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel" id="status-panel" style="display: none;">
            <div class="status-content">
                <div class="status-icon" id="status-icon"></div>
                <div class="status-text">
                    <div class="status-title" id="status-title"></div>
                    <div class="status-message" id="status-message"></div>
                </div>
            </div>
        </div>

        <!-- Guide Section -->
        <section class="guide-section">
            <div class="section-header">
                <h2 class="section-title">Jira ↔ Markdown 변환 가이드</h2>
                <p class="section-subtitle">양방향 문법 변환으로 더 효율적인 문서 작업을 시작하세요</p>
            </div>
            
            <div class="guide-grid">
                <div class="guide-card" onclick="toggleGuideContent('jira-syntax')">
                    <div class="guide-card-header">
                        <h3>Jira 문법 가이드</h3>
                        <span class="expand-icon">▼</span>
                    </div>
                    <p class="guide-card-desc">Jira에서 사용하는 다양한 텍스트 포맷팅 문법을 알아보세요</p>
                    <div class="guide-content" id="jira-syntax-content">
                        <div class="content-example">
                            <h4>기본 텍스트 포맷팅:</h4>
                            <pre><code>*굵은 글씨*
_기울임 글씨_
-취소선-
{{단순 텍스트}}
{code:java}
코드 블록
{code}</code></pre>
                        </div>
                        <div class="content-example">
                            <h4>목록과 인용:</h4>
                            <pre><code>* 불릿 목록
# 번호 목록
bq. 인용문</code></pre>
                        </div>
                    </div>
                </div>

                <div class="guide-card" onclick="toggleGuideContent('markdown-syntax')">
                    <div class="guide-card-header">
                        <h3>Markdown 문법 가이드</h3>
                        <span class="expand-icon">▼</span>
                    </div>
                    <p class="guide-card-desc">GitHub, Notion 등에서 사용하는 표준 Markdown 문법 정리</p>
                    <div class="guide-content" id="markdown-syntax-content">
                        <div class="content-example">
                            <h4>기본 텍스트 포맷팅:</h4>
                            <pre><code>**굵은 글씨**
*기울임 글씨*
~~취소선~~
`인라인 코드`
```java
코드 블록
```</code></pre>
                        </div>
                        <div class="content-example">
                            <h4>목록과 인용:</h4>
                            <pre><code>- 불릿 목록
1. 번호 목록
> 인용문</code></pre>
                        </div>
                    </div>
                </div>

                <div class="guide-card" onclick="toggleGuideContent('conversion-tips')">
                    <div class="guide-card-header">
                        <h3>변환 팁</h3>
                        <span class="expand-icon">▼</span>
                    </div>
                    <p class="guide-card-desc">효율적인 변환을 위한 유용한 팁과 주의사항</p>
                    <div class="guide-content" id="conversion-tips-content">
                        <div class="content-example">
                            <h4>변환 시 주의사항:</h4>
                            <ul style="padding-left: 1.5rem; color: #4b5563;">
                                <li>이미지는 첨부파일 정보가 필요합니다</li>
                                <li>테이블 구조는 정확히 맞춰야 합니다</li>
                                <li>중첩된 목록의 들여쓰기에 주의하세요</li>
                                <li>링크 형식은 자동으로 변환됩니다</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-text">
            <p>© 2025 QuickDevKit. Jira와 Markdown 간 양방향 변환 도구</p>
            <p style="margin-top: 0.25rem;">빠르고 정확한 문법 변환으로 문서 작업을 효율화하세요</p>
        </div>
    </footer>

    <script>
        // Global variables
        let jiraEditor, markdownEditor;
        let isDarkMode = false;

        // Jira to Markdown conversion function (from provided Python code)
        function jiraToMarkdown(text, attachments = []) {
            // 코드 블록을 먼저 추출하여 보관
            const codeBlocks = [];

            function extractCodeBlocks(match) {
                const lang = match[2] || '';
                const code = match[3];
                const placeholder = `@@CODE@@BLOCK@@${codeBlocks.length}@@`;
                codeBlocks.push(`\`\`\`${lang}\n${code}\n\`\`\``);
                return placeholder;
            }

            // 코드 블록을 추출하고 플레이스홀더로 대체
            text = text.replace(/\{code(:([a-z]+))?\}(.*?)\{code\}/gs, extractCodeBlocks);

            // 링크 패턴 추출하여 보관
            const links = [];

            function extractLinks(match) {
                const linkText = match[1];
                const linkUrl = match[2];
                const placeholder = `@@LINK@@${links.length}@@`;
                links.push(`[${linkText}](${linkUrl})`);
                return placeholder;
            }

            // 링크를 추출하고 플레이스홀더로 대체 (더 정확한 패턴 사용)
            text = text.replace(/\[([^\|\]]+)\|([^\]]+)\]/g, extractLinks);

            // 이미지 패턴 추출하여 보관
            const images = [];

            function extractImages(match) {
                // 파일명과 지시자 부분 분리 (예: '모니터링-8.png|thumbnail')
                const filenameWithDirectives = match[1];

                // '|' 뒤의 지시자가 있으면 제거
                const filename = filenameWithDirectives.split('|')[0].trim();

                // attachments 배열에서 일치하는 파일명 찾기
                let imageUrl = null;
                for (const attachment of attachments) {
                    if (attachment.filename === filename) {
                        imageUrl = attachment.content;
                        break;
                    }
                }

                // 이미지 URL을 찾지 못한 경우 원래 파일명을 URL로 사용
                if (!imageUrl) {
                    imageUrl = filename;
                }

                const placeholder = `@@IMAGE@@${images.length}@@`;
                // alt 텍스트로 파일명 사용
                images.push(`![${filename}](${imageUrl})`);
                return placeholder;
            }

            // 이미지를 추출하고 플레이스홀더로 대체 (더 정확한 패턴 사용)
            text = text.replace(/!([^!]+)!/g, extractImages);

            function jiraListToMarkdown(text) {
                const lines = text.split('\n');
                const markdownLines = [];

                for (const line of lines) {
                    const strippedLine = line.trim();
                    if (strippedLine.startsWith('*') || strippedLine.startsWith('#')) {
                        // 첫 번째 공백까지의 문자열 추출
                        const prefixMatch = strippedLine.match(/^[*#]+/);
                        if (prefixMatch) {
                            const prefix = prefixMatch[0];

                            // indent_level 계산 (*와 #의 합)
                            const indentLevel = prefix.length;

                            // 마지막 문자로 bulleted/numbered 결정
                            const isBulleted = prefix[prefix.length - 1] === '*';

                            const content = strippedLine.substring(prefix.length).trim();

                            let markdownLine;
                            if (isBulleted) {
                                markdownLine = '  '.repeat(indentLevel - 1) + '- ' + content;
                            } else { // numbered
                                markdownLine = '  '.repeat(indentLevel - 1) + '1. ' + content;
                            }

                            markdownLines.push(markdownLine);
                        } else {
                            markdownLines.push(line);
                        }
                    } else {
                        // 리스트가 아닌 줄은 그대로 유지
                        markdownLines.push(line);
                    }
                }

                return markdownLines.join('\n');
            }

            // 변환 로직 적용
            text = text.replace(/-(.+?)-/g, '~~$1~~');
            text = jiraListToMarkdown(text);
            text = text.replace(/\*(.+?)\*/g, '**$1**');
            text = text.replace(/_(.+?)_/g, '*$1*');
            text = text.replace(/^bq\.\s(.+)/gm, '> $1');
            text = text.replace(/\{\{(.+?)\}\}/g, '`$1`');
            text = text.replace(/^h1\.\s(.+)/gm, '# $1');
            text = text.replace(/^h2\.\s(.+)/gm, '## $1');
            text = text.replace(/^h3\.\s(.+)/gm, '### $1');
            text = text.replace(/^h4\.\s(.+)/gm, '#### $1');
            text = text.replace(/^h5\.\s(.+)/gm, '##### $1');
            text = text.replace(/^h6\.\s(.+)/gm, '###### $1');

            // {quote} 매크로 변환
            function quoteReplace(match) {
                const quotedText = match[1].trim();
                const lines = quotedText.split('\n');
                const quotedLines = lines.map(line => `> ${line}`);
                return quotedLines.join('\n');
            }
            text = text.replace(/\{quote\}(.*?)\{quote\}/gs, quoteReplace);

            // 테이블 변환
            function tableReplace(match) {
                const rows = match[0].trim().split('\n');
                const markdownTable = [];
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.startsWith('||')) { // 헤더 행
                        const cells = row.replace(/^\|\||\|\|$/g, '').split('||').map(cell => cell.trim());
                        const markdownRow = `| ${cells.join(' | ')} |`;
                        markdownTable.push(markdownRow);
                        const separator = `|${cells.map(() => '---').join('|')}|`;
                        markdownTable.push(separator);
                    } else if (row.startsWith('|')) { // 데이터 행
                        const cells = row.replace(/^\||\|$/g, '').split('|').map(cell => cell.trim());
                        const markdownRow = `| ${cells.join(' | ')} |`;
                        markdownTable.push(markdownRow);
                    }
                }
                return markdownTable.join('\n');
            }

            text = text.replace(/(\|\|.+?\|\|[\s\S]*?)(?=\n\n|$)/gm, tableReplace);

            // 링크 다시 삽입
            for (let i = 0; i < links.length; i++) {
                text = text.replace(`@@LINK@@${i}@@`, links[i]);
            }

            // 이미지 다시 삽입
            for (let i = 0; i < images.length; i++) {
                text = text.replace(`@@IMAGE@@${i}@@`, images[i]);
            }

            // 코드 블록 다시 삽입
            for (let i = 0; i < codeBlocks.length; i++) {
                text = text.replace(`@@CODE@@BLOCK@@${i}@@`, codeBlocks[i]);
            }

            return text;
        }

        // Markdown to Jira conversion function
        function markdownToJira(text) {
            // 1. 코드 블록을 먼저 추출하여 보관
            const codeBlocks = [];
            text = text.replace(/```(\w+)?\n([\s\S]*?)\n```/g, function(match, lang, code) {
                const placeholder = `@@CODE@@BLOCK@@${codeBlocks.length}@@`;
                codeBlocks.push(`{code${lang ? ':' + lang : ''}}\n${code}\n{code}`);
                return placeholder;
            });

            // 2. 인라인 코드 추출하여 보관
            const inlineCodes = [];
            text = text.replace(/`([^`]+)`/g, function(match, code) {
                const placeholder = `@@INLINE@@CODE@@${inlineCodes.length}@@`;
                inlineCodes.push(`{{${code}}}`);
                return placeholder;
            });

            // 3. 링크 패턴 추출하여 보관
            const links = [];
            text = text.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, function(match, linkText, linkUrl) {
                const placeholder = `@@LINK@@${links.length}@@`;
                links.push(`[${linkText}|${linkUrl}]`);
                return placeholder;
            });

            // 4. 이미지 패턴 추출하여 보관
            const images = [];
            text = text.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, function(match, altText, imageUrl) {
                const placeholder = `@@IMAGE@@${images.length}@@`;
                const filename = imageUrl.split('/').pop() || altText || 'image';
                images.push(`!${filename}!`);
                return placeholder;
            });

            // 5. 목록 변환
            function markdownListToJira(text) {
                const lines = text.split('\n');
                const jiraLines = [];

                for (const line of lines) {
                    // 번호 목록 처리 (1. 2. 3. ...)
                    const numberedMatch = line.match(/^(\s*)(\d+)\.\s(.+)/);
                    if (numberedMatch) {
                        const indent = numberedMatch[1];
                        const content = numberedMatch[3];
                        const level = Math.floor(indent.length / 2) + 1;
                        jiraLines.push('#'.repeat(level) + ' ' + content);
                        continue;
                    }

                    // 불릿 목록 처리 (- * +)
                    const bulletMatch = line.match(/^(\s*)[-*+]\s(.+)/);
                    if (bulletMatch) {
                        const indent = bulletMatch[1];
                        const content = bulletMatch[2];
                        const level = Math.floor(indent.length / 2) + 1;
                        jiraLines.push('*'.repeat(level) + ' ' + content);
                        continue;
                    }

                    // 리스트가 아닌 줄은 그대로 유지
                    jiraLines.push(line);
                }

                return jiraLines.join('\n');
            }

            // 6. 텍스트 포맷팅 변환 (순서 중요!)
            text = text.replace(/~~(.+?)~~/g, '-$1-');  // 취소선
            text = markdownListToJira(text);            // 목록
            text = text.replace(/\*\*(.+?)\*\*/g, '*$1*');  // 굵은 글씨
            // 이탤릭 처리를 더 안전하게 수정 (플레이스홀더를 피하도록)
            text = text.replace(/(?<![@\*])\*([^*\n]+?)\*(?![@\*])/g, '_$1_');  // 기울임
            text = text.replace(/^>\s(.+)/gm, 'bq. $1');  // 인용문
            
            // 7. 제목 변환 (h6부터 h1 순서로 - 긴 것부터)
            text = text.replace(/^######\s(.+)/gm, 'h6. $1');
            text = text.replace(/^#####\s(.+)/gm, 'h5. $1');
            text = text.replace(/^####\s(.+)/gm, 'h4. $1');
            text = text.replace(/^###\s(.+)/gm, 'h3. $1');
            text = text.replace(/^##\s(.+)/gm, 'h2. $1');
            text = text.replace(/^#\s(.+)/gm, 'h1. $1');

            // 8. 테이블 변환
            text = text.replace(/^\|.+\|$/gm, function(match, offset, string) {
                // 테이블의 전체 블록을 찾기
                const lines = string.split('\n');
                const currentLineIndex = string.substring(0, offset).split('\n').length - 1;
                
                // 현재 라인부터 테이블 블록 찾기
                const tableLines = [];
                let i = currentLineIndex;
                
                // 테이블 시작점 찾기
                while (i >= 0 && lines[i].match(/^\|.+\|$/)) {
                    i--;
                }
                i++; // 첫 번째 테이블 라인
                
                // 테이블 라인들 수집
                while (i < lines.length && lines[i].match(/^\|.+\|$/)) {
                    const line = lines[i].trim();
                    // 구분선이 아닌 경우만 추가
                    if (!line.match(/^\|[\s\-\|]+\|$/)) {
                        tableLines.push(line);
                    }
                    i++;
                }
                
                if (tableLines.length === 0) return match;
                
                // 첫 번째 라인인 경우에만 전체 테이블 변환
                if (currentLineIndex === i - tableLines.length || 
                    !lines[currentLineIndex - 1] || 
                    !lines[currentLineIndex - 1].match(/^\|.+\|$/)) {
                    
                    const jiraTable = [];
                    for (let j = 0; j < tableLines.length; j++) {
                        const line = tableLines[j];
                        const cells = line.slice(1, -1).split('|').map(cell => cell.trim());
                        
                        if (j === 0) { // 헤더 행
                            jiraTable.push(`||${cells.join('||')}||`);
                        } else { // 데이터 행
                            jiraTable.push(`|${cells.join('|')}|`);
                        }
                    }
                    
                    // 다른 테이블 라인들을 빈 문자열로 교체하기 위해 표시
                    for (let j = 1; j < tableLines.length; j++) {
                        const lineIndex = currentLineIndex + j;
                        if (lineIndex < lines.length) {
                            lines[lineIndex] = '@@TABLE@@PROCESSED@@';
                        }
                    }
                    
                    return jiraTable.join('\n');
                } else if (match === '@@TABLE@@PROCESSED@@') {
                    return '';
                }
                
                return match;
            });

            // 9. 인용 블록 변환 (여러 줄)
            text = text.replace(/(^bq\. .+(\nbq\. .*)*)/gm, function(match) {
                const lines = match.split('\n');
                const quotedLines = lines.map(line => line.replace(/^bq\. /, ''));
                return `{quote}\n${quotedLines.join('\n')}\n{quote}`;
            });

            // 10. 플레이스홀더들을 원래 내용으로 복원
            // 링크 복원
            for (let i = 0; i < links.length; i++) {
                text = text.replace(`@@LINK@@${i}@@`, links[i]);
            }

            // 이미지 복원
            for (let i = 0; i < images.length; i++) {
                text = text.replace(`@@IMAGE@@${i}@@`, images[i]);
            }
            
            // 인라인 코드 복원
            for (let i = 0; i < inlineCodes.length; i++) {
                text = text.replace(`@@INLINE@@CODE@@${i}@@`, inlineCodes[i]);
            }

            // 코드 블록 복원
            for (let i = 0; i < codeBlocks.length; i++) {
                text = text.replace(`@@CODE@@BLOCK@@${i}@@`, codeBlocks[i]);
            }

            return text;
        }

        // Initialize CodeMirror editors
        function initializeEditors() {
            // Jira editor
            jiraEditor = CodeMirror(document.getElementById('jira-editor'), {
                mode: 'text/plain',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: 10,
                scrollbarStyle: "native",
                placeholder: 'Jira 문법을 입력하세요...',
                theme: 'default'
            });

            // Markdown editor
            markdownEditor = CodeMirror(document.getElementById('markdown-editor'), {
                mode: 'markdown',
                lineNumbers: true,
                lineWrapping: true,
                viewportMargin: 10,
                scrollbarStyle: "native",
                placeholder: 'Markdown 문법을 입력하세요...',
                theme: 'default'
            });

            // Refresh editors to ensure proper rendering
            setTimeout(() => {
                if (jiraEditor && markdownEditor) {
                    jiraEditor.refresh();
                    markdownEditor.refresh();
                    
                    // 윈도우 리사이즈 이벤트 핸들러
                    window.addEventListener('resize', function() {
                        setTimeout(() => {
                            jiraEditor.refresh();
                            markdownEditor.refresh();
                        }, 100);
                    });
                }
            }, 200);

            // Apply initial theme
            applyEditorTheme();
        }

        // Convert Jira to Markdown
        function convertJiraToMarkdown() {
            const jiraText = jiraEditor.getValue().trim();
            if (!jiraText) {
                showStatus('error', '변환 실패', 'Jira 텍스트를 입력해주세요.');
                return;
            }

            try {
                const markdownText = jiraToMarkdown(jiraText);
                markdownEditor.setValue(markdownText);
                showStatus('success', '변환 완료', 'Jira 문법이 Markdown으로 성공적으로 변환되었습니다.');
            } catch (error) {
                showStatus('error', '변환 실패', error.message);
            }
        }

        // Convert Markdown to Jira
        function convertMarkdownToJira() {
            const markdownText = markdownEditor.getValue().trim();
            if (!markdownText) {
                showStatus('error', '변환 실패', 'Markdown 텍스트를 입력해주세요.');
                return;
            }

            try {
                const jiraText = markdownToJira(markdownText);
                jiraEditor.setValue(jiraText);
                showStatus('success', '변환 완료', 'Markdown 문법이 Jira로 성공적으로 변환되었습니다.');
            } catch (error) {
                showStatus('error', '변환 실패', error.message);
            }
        }

        // Sample loading functions
        function loadJiraSample() {
            const sample = `h1. 프로젝트 개요

이 프로젝트는 *중요한* 기능을 구현합니다.

h2. 기능 목록

* 첫 번째 기능
** 세부 기능 1
** 세부 기능 2
* 두 번째 기능

# 작업 순서
## 1단계 작업
## 2단계 작업

bq. 이것은 중요한 인용문입니다.

{code:java}
public class Example {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
{code}

||제목1||제목2||제목3||
|데이터1|데이터2|데이터3|
|데이터4|데이터5|데이터6|

[링크 텍스트|https://example.com]

!이미지파일.png!

{quote}
여러 줄에 걸친
인용문 예시입니다.
{quote}`;
            
            jiraEditor.setValue(sample);
            jiraEditor.focus();
        }

        function loadMarkdownSample() {
            const sample = `# 프로젝트 개요

이 프로젝트는 **중요한** 기능을 구현합니다.

## 기능 목록

- 첫 번째 기능
  - 세부 기능 1
  - 세부 기능 2
- 두 번째 기능

1. 1단계 작업
2. 2단계 작업

> 이것은 중요한 인용문입니다.

\`\`\`java
public class Example {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
\`\`\`

| 제목1 | 제목2 | 제목3 |
|-------|-------|-------|
| 데이터1 | 데이터2 | 데이터3 |
| 데이터4 | 데이터5 | 데이터6 |

[링크 텍스트](https://example.com)

![이미지파일](이미지파일.png)

> 여러 줄에 걸친
> 인용문 예시입니다.`;
            
            markdownEditor.setValue(sample);
            markdownEditor.focus();
        }

        // Clear functions
        function clearJiraInput() {
            jiraEditor.setValue('');
            jiraEditor.focus();
            hideStatus();
        }

        function clearMarkdownInput() {
            markdownEditor.setValue('');
            markdownEditor.focus();
            hideStatus();
        }

        // Copy functions
        async function copyJiraInput() {
            const text = jiraEditor.getValue();
            if (!text) return;

            try {
                await navigator.clipboard.writeText(text);
                showCopiedBadge('jira-copied-badge');
            } catch (err) {
                alert('복사에 실패했습니다.');
            }
        }

        async function copyMarkdownInput() {
            const text = markdownEditor.getValue();
            if (!text) return;

            try {
                await navigator.clipboard.writeText(text);
                showCopiedBadge('markdown-copied-badge');
            } catch (err) {
                alert('복사에 실패했습니다.');
            }
        }

        // Show copied badge
        function showCopiedBadge(badgeId) {
            const badge = document.getElementById(badgeId);
            badge.classList.add('show');
            
            setTimeout(() => {
                badge.classList.remove('show');
            }, 2000);
        }

        // Show status message
        function showStatus(type, title, message) {
            const panel = document.getElementById('status-panel');
            const icon = document.getElementById('status-icon');
            const titleEl = document.getElementById('status-title');
            const messageEl = document.getElementById('status-message');

            panel.className = `status-panel status-${type}`;
            panel.style.display = 'block';
            
            icon.innerHTML = type === 'success' ? '✅' : '❌';
            titleEl.textContent = title;
            messageEl.textContent = message;
        }

        // Hide status panel
        function hideStatus() {
            document.getElementById('status-panel').style.display = 'none';
        }

        // Toggle theme
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            document.getElementById('theme-icon').textContent = isDarkMode ? '☀️' : '🌙';
            applyEditorTheme();
        }

        // Apply editor theme
        function applyEditorTheme() {
            const theme = isDarkMode ? 'material-darker' : 'default';
            
            if (jiraEditor) {
                jiraEditor.setOption('theme', theme);
                jiraEditor.refresh();
            }
            if (markdownEditor) {
                markdownEditor.setOption('theme', theme);
                markdownEditor.refresh();
            }
        }

        // Toggle guide content
        function toggleGuideContent(contentId) {
            const content = document.getElementById(contentId + '-content');
            const card = content.closest('.guide-card');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                card.classList.remove('expanded');
            } else {
                // Close all other guide contents first
                document.querySelectorAll('.guide-content.show').forEach(el => {
                    el.classList.remove('show');
                    el.closest('.guide-card').classList.remove('expanded');
                });
                
                // Open current content
                content.classList.add('show');
                card.classList.add('expanded');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if CodeMirror is loaded
            if (typeof CodeMirror === 'undefined') {
                alert('Error loading code editor. Please refresh the page.');
                return;
            }
            
            // Initialize editors
            initializeEditors();
            
            // Auto-focus jira editor
            setTimeout(() => {
                if (jiraEditor) {
                    jiraEditor.focus();
                }
            }, 100);
        });
    </script>
</body>
</html>
